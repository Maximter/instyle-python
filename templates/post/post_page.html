<!DOCTYPE html>
<html lang="ru">
  {% load static%}
  <head>
    <meta charset="utf-8" />
    <title>Instyle</title>
    <link rel="stylesheet" href="{% static "css/post-img.css" %}" />
    <link rel="shortcut icon" type="image/x-icon"  href="{% static "img/system/title-logo.png" %}" />
  </head>
  <body>
    <header>
      <section>
        <a href="/"><p class="logo-name">Instyle</p></a>
        <div class="header-icons">
          <a href="/"><img src="{% static "img/system/home-empty.svg" %}" alt="Главная страница" title="Главная страница"></a>
          <a href="/chat"><img src="{% static "img/system/chat-empty.svg" %}" alt="Мессенджер" title="Мессенджер"></a>
          <a href="/post"><img src="{% static "img/system/add-empty.svg" %}" alt="Добавить фотографию" title="Добавить фотографию"></a>
          <a href="/recommendation"><img src="{% static "img/system/compass-empty.svg" %}" alt="Рекомендуемое" title="Рекомендуемое"></a>
          <a href="/notification"><img src="{% static "img/system/notification-empty.svg" %}" alt="Уведомления" title="Уведомления"></a>
          <a href="/user/{{user.username}}">
            {%if user.avatar%}
            <img src="{% static 'img/small/avatar/{{user.id}}.png' %}" alt="{{user.name_lastname}}" title="{{user.name_lastname}}" class="user-avatar" id="upper-avatar">
            {%else%}
            <img src="{% static 'img/small/avatar/standard.png' %}" alt="{{user.name_lastname}}" title="{{user.name_lastname}}" class="user-avatar" id="upper-avatar">
            {%endif%}
        </a></div>
      </section>
    </header>
    <div id="particles-js">
    
    <section class="main-section" id="one-section">
      <div class="photo-section">
        <div class="owner-block">
          <a href="/user/{{post.user.username}}" style="display: flex;">
            {%if post.user.avatar%}
            <img src="{% static 'img/small/avatar/{{post.user.id}}.png' %}" alt="{{post.user.name_lastname}}" title="{{post.user.name_lastname}}" class="owner-avatar">
            {%else%}
            <img src="{% static 'img/small/avatar/standard.png' %}" alt="{{post.user.name_lastname}}" title="{{post.user.name_lastname}}" class="owner-avatar">
            {%endif%}
            <p class="owner-username">{{post.user.username}}</p>   
          </a>
          <div style="display: flex;">
            <p class="date-of-post">{{post.date_post}}</p>
            <img src="{% static 'img/system/more.svg' %}" title="Ещё" class="more" onclick="more()">
          </div>
         
        </div>

        {%if post.mp4%}
          <video class="post-pic" controls="controls">
            <source src="{% static 'img/video/{{post.user.id}}/{{post.id_post}}.mp4' %}" type='video/mp4;'>
          </video>
        {%else%}
          <img src="/static/img/big/post/{{post.user.id}}/{{post.id_post}}.jpg" class="post-pic">
        {%endif%}
      </div>

      <div class="under-post-buttons">
        {%if user.post_interaction.like%}
            <img src="{% static 'img/system/liked.svg' %}" title="Нравится" class="like" onclick="like(this, '{{post.id_post}}')">
        {%else%}
            <img src="{% static 'img/system/notification-empty.svg' %}" title="Нравится" class="like" onclick="like(this, '{{post.id_post}}')">
        {%endif%}
            <p class="comment-text" style="margin: 0 0 0 10px;"><span style="font-weight: 500; " id="likes_{{post.id_post}}" likes="{{post.interaction.like_count}}" >Отметок нравится: {{post.interaction.like_count}}</span></p>
        </div>
        
       <div class="comments">
          {%if post.comment%}<p class="comment-text"><a href="/user/{{user.username}}"><span style="font-weight: 500;">{{post.user.username}}:</span></a> {{post.comment}}</p>{%endif%}
          {%for this in post.interaction.info%}
          <p class="comment-text"><a href="/user/{{user.username}}"><span style="font-weight: 500;">{{this.user.username}}:</span></a> {{this.comment}}</p>
          {%endfor%}
        </div>
      <div class="input-box">
        <input type="text" class="input-text" id="input_comment" placeholder="Оставьте комментарий...">
        <img class="imgSend" onclick="send_comment('{{post.id_post}}')" src="{% static 'img/system/send.svg' %}">
      </div>
    </div> 
  </section>

    

    <script src="{% static 'js/sweetalert2.all.min.js' %}"></script>
    <script src="{% static "js/particles.js" %}"></script>
    <script src="{% static "js/particles-start.js" %}"></script>
    {% csrf_token %}
    <script>
      function like (el, id_img) {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(`${window.location.origin}/post/like/${id_img}/`, {
          method: "post",
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
          },
        });
        const count = document.getElementById(`likes_${id_img}`);

        if (el.src.indexOf('notification') > -1) {
          el.src = "/static/img/system/liked.svg";
          count.attributes.likes.value = ++count.attributes.likes.value;
        }
        else {
          count.attributes.likes.value = --count.attributes.likes.value;
          el.src = "/static/img/system/notification-empty.svg";
        }
        count.innerHTML = `Отметок нравится: ${count.attributes.likes.value}`;
      }

      function close_menu() {
        Swal.fire({
              position: 'top',
              showConfirmButton: false,
              timer: 1
            })
          }
    
      function edit_comment(comment, id_img) {
        Swal.fire({
              position: 'top',
              title: 'Редактирование описания',
              html: `<textarea type="text" class="post-info-textbox" placeholder="Напишите описание к фотографии..." id="new-comment" name="new-comment">{{post.comment}}</textarea> <br>`,
              showConfirmButton: true,
              confirmButtonText: 'Сохранить',
              confirmButtonColor: 'rgb(0, 204, 0)'
            }).then((result) => {
    
     if (result.isConfirmed) {
      
       comment = document.getElementById('new-comment').value
       if (comment.length < 10 || comment.length > 1500)  {
          Swal.fire({
             position: 'top',
             icon: 'error',
             title: 'Длина описания слишком короткая или слишком длинная',
             showConfirmButton: true,
           })
           return
        }
       const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
       fetch(`${window.location.origin}/post/edit/${id_img}/`, {
         method: "post",
         body: JSON.stringify({'comment': comment}),
         headers: {
           'Accept': 'application/json',
           'Content-Type': 'application/json',
           'X-CSRFToken': csrftoken,
         },
       }).then(response => response)
         .then(result => { 
           Swal.fire({
             position: 'top',
             icon: 'success',
             title: 'Описание было изменено',
             showConfirmButton: false,
             timer: 1000
           }).then(() => {
             window.location.href = `${window.location.origin}/post/${id_img}/`
           })
         })
     }
     
     });
      }

      function copy (){
        navigator.clipboard.writeText(window.location.href)
          .then(() => {
             Swal.fire({
              position: 'top',
              icon: 'success',
              title: 'Ссылка на пост была скопирована',
              showConfirmButton: false,
              timer: 1000
            })
          })
          .catch(err => {
              Swal.fire({
                position: 'top',
                icon: 'error',
                title: 'Упс, что-то пошло не по плану. Сообщите об этом нам',
                showConfirmButton: false,
                timer: 2000
              })
          });
      }
    
      function send_comment(id_img) {
        const input_comment = document.getElementById('input_comment').value
        if (input_comment.length < 2 || input_comment.length > 1500) {
          Swal.fire({
             position: 'top',
             icon: 'error',
             title: 'Длина комментария слишком короткая или слишком длинная',
             showConfirmButton: true,
           })
           return
        }
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(`${window.location.origin}/post/comment/${id_img}/`, {
         method: "post",
         body: JSON.stringify({'comment': input_comment}),
         headers: {
           'Accept': 'application/json',
           'Content-Type': 'application/json',
           'X-CSRFToken': csrftoken,
         },
       }).then(response => response)
         .then(result => { 
           Swal.fire({
             position: 'top',
             icon: 'success',
             title: 'Комментарий оставлен',
             showConfirmButton: false,
             timer: 1000
           }).then(() => {
             window.location.href = `${window.location.origin}/post/${id_img}/`
           })
         })
      }
    </script>



    {%if user.owner%}
    <script>
    function deletePost(id_img, username) {
      Swal.fire({
      position: 'top',
      icon: 'warning',
      title: 'Вы действительно хотите удалить пост?',
      confirmButtonText: 'Да',
      showCancelButton: true,
      cancelButtonText: 'Нет',
      confirmButtonColor: '#ff3535',
      cancelButtonColor: '#00cc00',
    }).then((result) => {
     
      if (result.isConfirmed) {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(`${window.location.origin}/post/delete/${id_img}/`, {
          method: "post",
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
          },
        }).then(response => response)
          .then(result => { 
            Swal.fire({
              position: 'top',
              icon: 'success',
              title: 'Пост был удален',
              showConfirmButton: false,
              timer: 1000
            }).then(() => {
              window.location.href = `${window.location.origin}/user/${username}`
            })
          })
      }
      
      });
    }
    </script>

    <script>
    function more() {
      Swal.fire({
        position: 'top',
        showCancelButton: false,
        showConfirmButton: false,
        html:`   <div class="more-menu">
      <p style="color: red;" onclick="deletePost('{{post.id_post}}', '{{user.username}}')">Удалить</p>
      <p onclick="copy()">Скопировать ссылку на пост</p>
      <p onclick="edit_comment('{{post.comment|stringformat:"i"}}', '{{post.id_post}}')">Редактировать описание</p>
      <p>Скрывать число отметок "Нравится"</p>
      <p>Выключить комментарии</p>
      <p onclick="close_menu()" style="border-bottom: none;">Отмена</p>
    </div>`, 
        
      })
      }
    </script>
    {%else%}
    <script>
      function more() {
        Swal.fire({
          position: 'top',
          showCancelButton: false,
          showConfirmButton: false,
          html:`   <div class="more-menu">
        <p onclick="copy()">Скопировать ссылку на пост</p>
        <p onclick="close_menu()" style="border-bottom: none;">Отмена</p>
      </div>`, 
          
        })
        }
      </script>
    {%endif%}
 



  </body>
</html>